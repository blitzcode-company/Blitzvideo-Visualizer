<div class="comentario" [id]="'comentario-' + comentario.id">
  <div class="comentario-header">
    <img *ngIf="comentario.user?.foto" [src]="comentario.user?.foto" class="fotoUsuario" alt="Foto del usuario">
    <img *ngIf="!comentario.user?.foto" src="assets/images/user.svg" class="fotoUsuario" alt="Foto del usuario">

    <div class="comentario-info">
      <div class="nombreyfecha">
        <strong>{{ comentario.user?.name }}</strong>
        <span class="date"> {{ comentario.created_at }}</span>
      </div>

      <div class="comentario-actions-menu">
        <button class="menu-button" (click)="toggleMenu($event)">⋮</button>
        <div *ngIf="showMenu" class="menu-dropdown">
          <ng-container *ngIf="comentario.puedeBorrar; else reportarMenu">
            <button *ngIf="comentario.user?.id === usuario?.id" (click)="toggleEdit(comentario)">
              <mat-icon>create</mat-icon> Editar
            </button>
            <button (click)="eliminarComentario()">
              <mat-icon>delete</mat-icon> Eliminar
            </button>
          </ng-container>
          <ng-template #reportarMenu>
            <button (click)="reportarComentario(comentario.id!)"><mat-icon>flag</mat-icon> Reportar comentario</button>
            <button (click)="reportarUsuario(comentario.usuario_id)"><mat-icon>flag</mat-icon>Reportar usuario</button>

          </ng-template>
        </div>
      </div>

      <div *ngIf="editingComentarioId === comentario.id" class="edit-comentario-form">
        <input [(ngModel)]="editingComentarioMensaje" placeholder="Edita tu comentario...">
        <button (click)="toggleEdit(null)"  class="btn btn-secondary">Cancelar</button>
        <button (click)="editarComentario(comentario)" class="btn btn-primary">Actualizar</button>

      </div>
    
      <p *ngIf="editingComentarioId !== comentario.id">{{ comentario.mensaje }} </p>
    

      <div class="megustas">
        <a href="#" *ngIf="!usuarioBloqueado" (click)="toggleResponder(comentario, $event)">Responder</a>

        <button *ngIf="!usuarioBloqueado && !comentario.likedByUser" (click)="darMeGusta()" class="botonLike" aria-label="Dar Me Gusta">
          <i class="fas fa-thumbs-up"></i>
        </button>
        
        <button *ngIf="!usuarioBloqueado && comentario.likedByUser" (click)="quitarMeGusta()" class="botonLike" aria-label="Quitar Me Gusta">
          <i class="fas fa-thumbs-up liked"></i>
          
        </button>
        <p class="contador">{{ comentario.contadorDeLikes || 0 }}</p>
      </div>
    </div>
      
  </div>

  <div class="comentario-footer">
    <a href="#"
       class="toggle-respuestas"
       *ngIf="comentario.respuestas && comentario.respuestas.length"
       (click)="toggleRespuestas(comentario); $event.preventDefault()">
  
      <mat-icon>
        {{ comentario.mostrarRespuestas ? 'expand_less' : 'expand_more' }}
      </mat-icon>
  
      <span>
        {{ comentario.mostrarRespuestas ? 'Ocultar respuestas' : 'Ver respuestas' }}
      </span>
    </a>
  </div>

<div *ngIf="selectedComentarioId === comentario.id" 
     class="respuesta-container"
     (click)="$event.stopPropagation()">
  
  <form (ngSubmit)="enviarRespuesta()" #respuestaForm="ngForm" class="respuesta-form">
    <div class="input-group">
      <div class="avatar-respuesta">
        <img [src]="usuario?.foto || 'assets/images/user.svg'" 
             class="avatar-pequeno" 
             alt="Tu foto">
      </div>

      <div class="input-wrapper">
        <input 
          #inputRespuesta
          type="text"
          [(ngModel)]="respuestaComentario.mensaje"
          name="mensaje"
          placeholder="Añade una respuesta..."
          required
          autocomplete="off"
          (keydown)="onKeydownRespuesta($event)"
          class="input-respuesta"
          [class.active]="respuestaComentario.mensaje?.length > 0"
          [disabled]="enviandoRespuesta"
        >

        <div class="botones-accion" *ngIf="respuestaComentario.mensaje?.length > 0">
          <button 
            type="button" 
            class="btn-cancelar" 
            (click)="cancelarRespuesta()"
            [disabled]="enviandoRespuesta"
            tabindex="-1">
            Cancelar
          </button>
          <button 
            type="submit" 
            class="btn-responder"
            (click)="$event.stopPropagation()"
            [disabled]="!respuestaForm.valid || enviandoRespuesta">
            <span *ngIf="!enviandoRespuesta">Responder</span>
            <mat-spinner *ngIf="enviandoRespuesta" diameter="16"></mat-spinner>
          </button>
        </div>

      </div>
    </div>
  </form>
</div>

  <div class="respuestas" *ngIf="comentario.mostrarRespuestas">
    <app-contenido-de-comentarios
      *ngFor="let respuesta of comentario.respuestas"
      [comentario]="respuesta"
      [videoId]="videoId"
      [usuario]="usuario"
      (nuevoComentario)="nuevoComentario.emit()"
      (comentarioEliminado)="comentarioEliminado.emit($event)"
      (comentarioEditado)="editarComentario($event)"
      
    ></app-contenido-de-comentarios>
  </div>
</div>